<%- include('partials/header') %>

    <div style="margin-top: 40px;">
        <div style="display:flex; justify-content:space-between; align-items: center;">
            <h1>Dashboard</h1>
            <p style="color: var(--text-muted);">Welcome back, <%= user.name %>! Showing totals in <strong>
                        <%= userCurrency %>
                    </strong></p>
        </div>

        <div class="dashboard-grid">
            <div class="stat-card">
                <span class="stat-label">Monthly Savings</span>
                <div class="stat-value">
                    <%= userCurrency %>
                        <%= savings.toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                </div>
            </div>
            <div class="stat-card" style="border-top: 4px solid #f59e0b;">
                <span class="stat-label">Total Savings</span>
                <div class="stat-value" style="color: #f59e0b;">
                    <%= userCurrency %>
                        <%= totalSavingsCompiled.toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                </div>
            </div>
            <div class="stat-card">
                <span class="stat-label">Expenses</span>
                <div class="stat-value" style="color: var(--danger);">
                    <%= userCurrency %> -<%= totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                </div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), #4338ca); color: white;">
                <span class="stat-label" style="color: rgba(255,255,255,0.8);">Total Balance</span>
                <div class="stat-value">
                    <%= userCurrency %>
                        <%= (totalIncome - totalExpense).toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="chart-container" style="grid-column: span 2;">
                <h3>Spending by Category</h3>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="stat-card">
                <div style="display:flex; justify-content:space-between; align-items: center;">
                    <h3>Budgets</h3>
                    <a href="/budgets" style="font-size: 0.9rem; color: var(--primary);">Manage Budget</a>
                </div>
                <div style="margin-top: 20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                        <span>Monthly Income:</span>
                        <span style="color: var(--success); font-weight: 600;">
                            <%= userCurrency %>
                                <%= totalIncome.toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                        </span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom: 10px;">
                        <span>Monthly Expenses:</span>
                        <span style="color: var(--danger); font-weight: 600;">
                            <%= userCurrency %>
                                <%= totalExpense.toLocaleString(undefined, {minimumFractionDigits: 2}) %>
                        </span>
                    </div>
                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 15px 0;">
                    <% if (budgetProgress && budgetProgress.length> 0) { %>
                        <% budgetProgress.forEach(b=> { %>
                            <div style="margin-bottom: 20px;">
                                <div
                                    style="display:flex; justify-content:space-between; margin-bottom: 8px; font-size: 0.9rem;">
                                    <span>
                                        <%= b.category %>
                                    </span>
                                    <span>
                                        <%= userCurrency %>
                                            <%= b.spent.toLocaleString(undefined, {maximumFractionDigits: 0}) %> of <%=
                                                    b.limit.toLocaleString() %>
                                    </span>
                                </div>
                                <div
                                    style="background: var(--bg-main); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div
                                        style="background: <%= b.percent > 90 ? 'var(--danger)' : 'var(--primary)' %>; width: <%= b.percent %>%; height: 100%; transition: 1s ease-out;">
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                                <% } else { %>
                                    <p
                                        style="color: var(--text-muted); font-size: 0.9rem; text-align: center; margin-top: 20px;">
                                        No budgets set for this month.</p>
                                    <% } %>
                </div>
            </div>
        </div>

        <div style="margin-top: 40px;">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 20px;">
                <h3>Recent Transactions</h3>
                <a href="/transactions" class="btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">View All</a>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (recentTransactions && recentTransactions.length> 0) { %>
                            <% recentTransactions.forEach(t=> { %>
                                <tr>
                                    <td>
                                        <%= t.date %>
                                    </td>
                                    <td>
                                        <%= t.Category ? t.Category.name : 'Other' %>
                                    </td>
                                    <td>
                                        <%= t.description %>
                                    </td>
                                    <td class="type-<%= t.type %>">
                                        <%= t.currency || 'USD' %>
                                            <%= t.type==='income' ? '+' : '-' %>
                                                <%= parseFloat(t.amount).toLocaleString() %>
                                    </td>
                                </tr>
                                <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: var(--text-muted);">No
                                                transactions found</td>
                                        </tr>
                                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pass data to JS for Chart -->
    <div id="chartData" data-labels='<%= JSON.stringify(Object.keys(categoryData)) %>'
        data-values='<%= JSON.stringify(Object.values(categoryData)) %>'>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataEl = document.getElementById('chartData');
            const labels = JSON.parse(dataEl.dataset.labels);
            const values = JSON.parse(dataEl.dataset.values);

            if (labels.length > 0) {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#6366f1', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#94a3b8',
                                    font: { family: "'Outfit', sans-serif" }
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            } else {
                document.querySelector('.chart-wrapper').innerHTML = '<p style="color: var(--text-muted); text-align: center; margin-top: 100px;">No expense data available for chart</p>';
            }
        });
    </script>

    <%- include('partials/footer') %>