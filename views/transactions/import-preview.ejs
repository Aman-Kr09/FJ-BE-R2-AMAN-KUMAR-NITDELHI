<%- include('../partials/header') %>

    <style>
        .import-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .import-table th {
            background: rgba(255, 255, 255, 0.02);
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 15px;
            text-align: left;
        }

        .import-table td {
            padding: 15px;
        }

        .badge-income {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-expense {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .trans-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .category-select {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            width: 100%;
            max-width: 200px;
            outline: none;
            transition: border-color 0.2s;
        }

        .category-select:focus {
            border-color: var(--primary);
        }

        .amount-income {
            color: var(--success);
            font-weight: 700;
            text-align: right;
        }

        .amount-expense {
            color: white;
            font-weight: 700;
            text-align: right;
        }
    </style>

    <div class="dashboard-container">
        <div
            style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
            <div>
                <h1 style="font-size: 2.2rem; margin: 0 0 5px 0;">Review Transactions</h1>
                <p style="color: var(--text-muted); margin: 0;">Found <strong>
                        <%= transactions.length %>
                    </strong> new entries. Check the details before confirming.</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <a href="/transactions/import" class="btn-outline" style="padding: 10px 20px;">Cancel</a>
                <button type="submit" form="confirm-form" class="btn-primary"
                    style="padding: 10px 25px; display: flex; align-items: center; gap: 8px;">
                    <i data-lucide="check-check" style="width: 18px;"></i>
                    Confirm Import
                </button>
            </div>
        </div>

        <% if (duplicates && duplicates.length> 0) { %>
            <div
                style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.3); padding: 15px 20px; border-radius: 12px; margin-bottom: 30px; display: flex; align-items: center; gap: 15px;">
                <div
                    style="width: 36px; height: 36px; background: rgba(245, 158, 11, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="shield-alert" style="color: #f59e0b; width: 20px;"></i>
                </div>
                <p style="margin: 0; color: #f59e0b; font-size: 0.95rem;">
                    <strong>
                        <%= duplicates.length %> Duplicates Detected.
                    </strong> These entries matched your history and were automatically hidden to avoid double entries.
                </p>
            </div>
            <% } %>

                <div class="table-container"
                    style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg-card);">
                    <form id="confirm-form" action="/transactions/import/confirm" method="POST">
                        <table class="import-table">
                            <thead style="border-bottom: 1px solid var(--border);">
                                <tr>
                                    <th style="width: 60px; text-align: center;">
                                        <input type="checkbox" id="select-all" checked
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th style="text-align: right;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (transactions.length===0) { %>
                                    <tr>
                                        <td colspan="6"
                                            style="text-align: center; padding: 80px; color: var(--text-muted);">
                                            <i data-lucide="check-circle-2"
                                                style="width: 48px; height: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                                            <p>No new transactions to import. You're all caught up!</p>
                                        </td>
                                    </tr>
                                    <% } %>
                                        <% transactions.forEach((trans, index)=> { %>
                                            <tr class="trans-row"
                                                style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                <td style="text-align: center;">
                                                    <input type="checkbox" name="transactions[<%= index %>][active]"
                                                        value="true" checked class="trans-checkbox"
                                                        style="width: 16px; height: 16px; cursor: pointer;">
                                                    <input type="hidden" name="transactions[<%= index %>][date]"
                                                        value="<%= trans.date %>">
                                                    <input type="hidden" name="transactions[<%= index %>][description]"
                                                        value="<%= trans.description %>">
                                                    <input type="hidden" name="transactions[<%= index %>][amount]"
                                                        value="<%= trans.amount %>">
                                                    <input type="hidden" name="transactions[<%= index %>][type]"
                                                        value="<%= trans.type %>">
                                                    <input type="hidden" name="transactions[<%= index %>][currency]"
                                                        value="<%= trans.currency %>">
                                                </td>
                                                <td style="font-family: monospace; color: var(--text-muted);">
                                                    <%= trans.date %>
                                                </td>
                                                <td style="font-weight: 500;">
                                                    <%= trans.description %>
                                                </td>
                                                <td>
                                                    <select name="transactions[<%= index %>][categoryId]"
                                                        class="category-select">
                                                        <option value="">Uncategorized</option>
                                                        <% categories.forEach(cat=> { %>
                                                            <option value="<%= cat.id %>" <%=trans.categoryId===cat.id
                                                                ? 'selected' : '' %>><%= cat.name %>
                                                            </option>
                                                            <% }) %>
                                                    </select>
                                                </td>
                                                <td>
                                                    <span
                                                        class="badge <%= trans.type === 'income' ? 'badge-income' : 'badge-expense' %>">
                                                        <%= trans.type %>
                                                    </span>
                                                </td>
                                                <td
                                                    class="<%= trans.type === 'income' ? 'amount-income' : 'amount-expense' %>">
                                                    <%= trans.currency %>
                                                        <%= parseFloat(trans.amount).toLocaleString(undefined,
                                                            {minimumFractionDigits: 2}) %>
                                                </td>
                                            </tr>
                                            <% }) %>
                            </tbody>
                        </table>
                    </form>
                </div>

                <% if (duplicates && duplicates.length> 0) { %>
                    <div style="margin-top: 60px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <h3 style="color: var(--text-muted); font-size: 1rem; margin: 0;">Skipped Transactions</h3>
                            <span
                                style="background: rgba(255,255,255,0.05); padding: 2px 10px; border-radius: 12px; font-size: 0.75rem; color: var(--text-muted);">
                                <%= duplicates.length %>
                            </span>
                        </div>
                        <div class="table-container"
                            style="opacity: 0.4; filter: grayscale(1); border: 1px dashed var(--border); border-radius: 12px; background: rgba(0,0,0,0.1);">
                            <table class="import-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th style="text-align: right;">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% duplicates.forEach(dup=> { %>
                                        <tr>
                                            <td>
                                                <%= dup.date %>
                                            </td>
                                            <td>
                                                <%= dup.description %>
                                            </td>
                                            <td style="text-align: right;">
                                                <%= dup.currency %>
                                                    <%= parseFloat(dup.amount).toLocaleString(undefined,
                                                        {minimumFractionDigits: 2}) %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <% } %>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.trans-checkbox');

            if (selectAll) {
                selectAll.addEventListener('change', () => {
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                });
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>

    <%- include('../partials/footer') %>