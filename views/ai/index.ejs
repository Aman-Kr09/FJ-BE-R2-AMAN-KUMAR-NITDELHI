<%- include('../partials/header') %>

    <div class="ai-container"
        style="max-width: 900px; margin: 20px auto; height: calc(100vh - 150px); display: flex; flex-direction: column;">
        <div class="ai-header"
            style="background: var(--bg-card); padding: 20px; border-radius: 16px 16px 0 0; border: 1px solid var(--border); border-bottom: none; display: flex; align-items: center; gap: 15px;">
            <div
                style="width: 45px; height: 45px; background: linear-gradient(135deg, #6366f1, #a855f7); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white;">
                <i data-lucide="sparkles"></i>
            </div>
            <div>
                <h2 style="margin: 0; font-size: 1.25rem;">FinanceGuru AI</h2>
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">Personalized Financial Advisor</p>
            </div>
        </div>

        <div id="chat-messages"
            style="flex: 1; background: var(--bg-card); border: 1px solid var(--border); padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;">
            <!-- Welcome Message -->
            <div class="message bot"
                style="max-width: 80%; align-self: flex-start; background: var(--bg-body); padding: 15px 20px; border-radius: 15px 15px 15px 0; border: 1px solid var(--border);">
                <p style="margin: 0;">Hello! I'm your AI financial advisor. ðŸš€</p>
                <p style="margin-top: 10px; font-size: 0.95rem;">I've analyzed your recent transactions and budgets. You
                    can ask me things like:</p>
                <ul style="margin-top: 10px; font-size: 0.9rem; padding-left: 20px; color: var(--text-muted);">
                    <li>"How can I save $500 this month?"</li>
                    <li>"Review my spending patterns."</li>
                    <li>"What are the best stocks to watch right now?"</li>
                    <li>"What is the current Repo rate in India?"</li>
                </ul>
            </div>
        </div>

        <div class="chat-input-area"
            style="background: var(--bg-card); padding: 20px; border-radius: 0 0 16px 16px; border: 1px solid var(--border); border-top: none;">
            <form id="chat-form" style="display: flex; gap: 12px;">
                <input type="text" id="user-input" placeholder="Type your financial question..." required
                    style="flex: 1; background: var(--bg-body); border: 1px solid var(--border); border-radius: 12px; padding: 12px 18px; color: white; outline: none;">
                <button type="submit" class="btn-primary"
                    style="padding: 0 25px; border-radius: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>Ask AI</span>
                    <i data-lucide="send" style="width: 18px;"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('user-input');
        const messagesContainer = document.getElementById('chat-messages');

        let history = [];

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (!message) return;

            // Append User Message
            appendMessage('user', message);
            chatInput.value = '';

            // Show Typing indicator
            const typingId = appendLoading();

            try {
                const res = await fetch('/auth/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, history })
                });

                const data = await res.json();

                // Remove Typing, Add Bot Message
                document.getElementById(typingId).remove();

                if (data.response) {
                    appendMessage('bot', data.response);
                    history.push({ role: 'user', content: message });
                    history.push({ role: 'assistant', content: data.response });

                    // Keep history trimmed to avoid token limits
                    if (history.length > 10) history = history.slice(-10);
                } else {
                    appendMessage('bot', 'Sorry, something went wrong. Try again later.');
                }
            } catch (err) {
                document.getElementById(typingId).remove();
                appendMessage('bot', 'Error connecting to AI service.');
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.style.maxWidth = '85%';
            div.style.padding = '15px 20px';
            div.style.borderRadius = '15px';
            div.style.fontSize = '0.95rem';
            div.style.lineHeight = '1.5';

            if (role === 'user') {
                div.style.alignSelf = 'flex-end';
                div.style.background = 'var(--primary)';
                div.style.color = 'white';
                div.style.borderRadius = '15px 15px 0 15px';
                div.innerText = text;
            } else {
                div.style.alignSelf = 'flex-start';
                div.style.background = 'var(--bg-body)';
                div.style.border = '1px solid var(--border)';
                div.style.borderRadius = '15px 15px 15px 0';
                // Simple markdown-ish bold handling
                div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            }

            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function appendLoading() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.style.alignSelf = 'flex-start';
            div.style.background = 'var(--bg-body)';
            div.style.border = '1px solid var(--border)';
            div.style.padding = '12px 20px';
            div.style.borderRadius = '15px 15px 15px 0';
            div.innerHTML = '<span class="typing-dot" style="animation: pulse 1s infinite;">Thinking...</span>';
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return id;
        }
    </script>

    <style>
        @keyframes pulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .message ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message li {
            margin-bottom: 5px;
        }
    </style>

    <%- include('../partials/footer') %>